<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Results</title>
  <script type='text/javascript' src='//outlinedistinguish.com/a7/bb/a4/a7bba4416dd09b629e395af74b3eb639.js'></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <link rel="icon" href="practisoV2logo.png" type="image/png"/>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
      background: #161616;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }

    .header {
      background: #232323;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      color: #ff69b4;
      margin: 0;
      font-size: 24px;
      text-align: left;
    }

    .header-buttons {
      display: flex;
      gap: 10px;
    }

    .header-btn {
      background: #ff69b4;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }

    .header-btn:hover {
      background: #ff69b4c0;
    }

    @media (max-width: 768px) {
      body{
        overflow-x: hidden;
      }
      .header {
        padding: 15px;
        flex-direction: column;
        gap: 10px;
      }

      .header h1 {
        font-size: 20px;
      }

      .header-buttons {
        width: 100%;
        justify-content: center;
      }

      .header-btn {
        padding: 6px 12px;
        font-size: 12px;
      }
    }

    .test-info {
      background: #282828;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid rgba(2, 255, 175, 0.1);
    }

    .test-info h2 {
      color: #fff;
      margin: 0 0 15px 0;
      font-size: 20px;
      border-bottom: 2px solid #ff69b4;
      padding-bottom: 10px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .info-item {
      background: #282828;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid gray;

    }

    .info-label {
      color: #aaa;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .info-value {
      color: #fff;
      font-size: 18px;
      font-weight: 600;
    }

    .subject-section {
      background: #232323;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .subject-title {
      color: #fff;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ff69b4;
    }

    .section-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .result-card {
      background: #282828;
      padding: 20px;
      border-radius: 6px;

    }

    .result-card h3 {
      color: #ff69b4;
      margin: 0 0 15px 0;
      font-size: 18px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .stat-item {
      background: #282828;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
    }

    .stat-label {
      color: #aaa;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #fff;
    }

    .correct {
      color: #28a745;
    }

    .incorrect {
      color: #dc3545;
    }

    .unattempted {
      color: #6c757d;
    }

    .total-score {
      background: #ff69b4;
      color: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin-top: 20px;
    }

    .error-message {
      background: #232323;
      color: #dc3545;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 18px;
    }

    .answers-review {
      background: #282828;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .tab-content {
      display: none;
      padding: 20px;
      background: #282828;
      border-radius: 8px;
    }
    .info-accuracy-wrapper {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    #test-info, #accuracy-section {
      flex: 1 1 0;
      max-width: 50%;
      min-width: 260px;
      background: #282828;
      padding: 20px;
      border-radius: 8px; 
      border: 1px solid rgba(2, 255, 175, 0.1);
      margin-bottom: 20px;
      color: #fff;
    }
    #accuracy-section h2 {
      color: #fff;
      font-size: 20px;
      margin: 0 0 15px 0;
      border-bottom: 2px solid #ff69b4;
      padding-bottom: 10px;
    }
    .accuracy-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .accuracy-list li {
      margin-bottom: 10px;
      font-size: 16px;
      border: 1px solid gray;
      padding: 15px;
      border-radius: 8px;
      margin-top: 13px;
      
    }
    .accuracy-label {
      color: #aaa;
      margin-right: 8px;
    }
    .accuracy-value {
      color: #fff;
      font-weight: 600;
    }
    @media (max-width: 900px) {
      .info-accuracy-wrapper {
        flex-direction: column;
        gap: 0;
        align-items: center;
      }
      #test-info, #accuracy-section {
        max-width: 100%;
        margin-top: 0;
        margin-bottom: 20px;
        margin-left: auto;
        margin-right: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #test-info .info-grid, #accuracy-section ul {
        align-items: center;
        justify-content: center;
        text-align: center;
      }
      #results-content table {
        margin-left: auto;
        margin-right: auto;
        text-align: center;
        width: 95vw;
        min-width: 600px;
      }
      #results-content thead, #results-content tbody {
        text-align: center;
      }
      .answers-review {
        overflow-x: auto;
        max-width: 100vw;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Test Results</h1>
      <div class="header-buttons">
        <button class="header-btn" onclick="window.location.href='dashboard.html'">Go to Dashboard</button>
      </div>
    </div>
    <div class="info-accuracy-wrapper">
      <div id="test-info" class="test-info">
        <h2>Test Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Test Date</div>
            <div class="info-value" id="test-date">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">Duration</div>
            <div class="info-value" id="test-duration">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">Total Questions</div>
            <div class="info-value" id="total-questions">75</div>
          </div>
          <div class="info-item">
            <div class="info-label">Questions Attempted</div>
            <div class="info-value" id="questions-attempted">-</div>
          </div>
        </div>
      </div>
      <div id="accuracy-section">
        <h2>Accuracy</h2>
        <ul class="accuracy-list" id="accuracy-list">
          <li>Loading accuracy...</li>
        </ul>
      </div>
    </div>
    <div id="results-content">
      <div class="loading">Loading results...</div>
    </div>
  </div>

  <script>
    // Prevent going back to exam UI
    if (window.history && window.history.pushState) {
      window.history.pushState(null, null, window.location.href);
      window.onpopstate = function() {
        window.history.pushState(null, null, window.location.href);
        window.location.href = 'dashboard.html';
      };
    }

    // Clear any test-related data
    localStorage.removeItem('test_in_progress');
    sessionStorage.clear();

    const firebaseConfig = {
      apiKey: "AIzaSyC5iCxiWXEAiUSQAO6uBvG6bL4udqWIlNg",
      authDomain: "practiso-9b3dd.firebaseapp.com",
      projectId: "practiso-9b3dd",
      storageBucket: "practiso-9b3dd.appspot.com",
      messagingSenderId: "263842850217",
      appId: "1:263842850217:web:129de6a752bd8831b150b8",
      measurementId: "G-CG44V5WG0G"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "/login.html";
        return;
      }
      loadResults(user.uid);
    });

    async function loadResults(userId) {
      const resultsContent = document.getElementById('results-content');
      let totalScore = 0;
      let accuracyData = {};
      let subjectwiseStats = {};
      let totalCorrect = 0, totalAttempted = 0;

      try {
        console.log('Loading results for user:', userId);
        
        // Get test_id from URL query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const selectedTestId = urlParams.get('test_id');
        
        let testDoc;
        if (selectedTestId) {
          // If a specific test was selected, fetch that test
          testDoc = await db.collection('user_test_responses')
            .doc(userId)
            .collection('test_attempts')
            .doc(selectedTestId)
            .get();
        } else {
          // If no specific test was selected, fetch the most recent test
          const recentTestsSnapshot = await db.collection('user_test_responses')
            .doc(userId)
            .collection('test_attempts')
            .orderBy('submittedAt', 'desc')
            .limit(1)
            .get();
          
          if (recentTestsSnapshot.empty) {
            showError('No test attempts found. Please complete a test first.');
            return;
          }
          
          testDoc = recentTestsSnapshot.docs[0];
        }
        
        if (!testDoc.exists) {
          showError('Test not found. Please try again.');
          return;
        }
        
        const responseData = testDoc.data();
        console.log('Loaded test from Firebase:', responseData);
        
        // Update test info
        document.getElementById('test-date').textContent = new Date(responseData.testInfo.startTime).toLocaleDateString();
        document.getElementById('test-duration').textContent = `${Math.floor(responseData.testInfo.duration / 60)} minutes`;
        document.getElementById('total-questions').textContent = '75';
        document.getElementById('questions-attempted').textContent = responseData.metadata.answeredQuestions;

        // Clear loading message
        resultsContent.innerHTML = '';

        // Subject summary table
        const subjectSummaryTable = document.createElement('table');
        subjectSummaryTable.style.width = '100%';
        subjectSummaryTable.style.borderCollapse = 'collapse';
        subjectSummaryTable.style.background = '#232323';
        subjectSummaryTable.style.color = '#fff';
        subjectSummaryTable.style.marginBottom = '30px';
        subjectSummaryTable.innerHTML = `
          <thead>
            <tr style="background:#232323; color:#fff;">
              <th style="padding:10px; border:1px solid #444;">Subject</th>
              <th style="padding:10px; border:1px solid #444;">Score</th>
              <th style="padding:10px; border:1px solid #444;">Attempted</th>
              <th style="padding:10px; border:1px solid #444;">Correct</th>
              <th style="padding:10px; border:1px solid #444;">Incorrect</th>
              <th style="padding:10px; border:1px solid #444;">Unattempted</th>
            </tr>
          </thead>
          <tbody id="subject-summary-body"></tbody>
        `;
        resultsContent.appendChild(subjectSummaryTable);

        // Process each section
        // (Removed: rendering of individual subject-section cards below the table)

        // Add total score after all sections are processed
        const totalScoreDiv = document.createElement('div');
        totalScoreDiv.className = 'total-score';
        totalScoreDiv.textContent = `Total Score: ${totalScore}`;
        document.getElementById('test-info').appendChild(totalScoreDiv);

        // Add tabs for answers review
        const answersReviewDiv = document.createElement('div');
        answersReviewDiv.className = 'answers-review';
        answersReviewDiv.style.cssText = `
          
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          margin-top: 20px;
        `;

        // Create tabs
        const tabsDiv = document.createElement('div');
        tabsDiv.style.cssText = `
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          border-bottom: 2px solid #eee;
          padding-bottom: 10px;
        `;

        const correctTab = document.createElement('button');
        correctTab.textContent = 'Correct Answers';
        correctTab.style.cssText = `
          padding: 10px 20px;
          background: #00ff00;
          color: #000;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-weight: bold;
        `;

        const wrongTab = document.createElement('button');
        wrongTab.textContent = 'Wrong Answers';
        wrongTab.style.cssText = `
          padding: 10px 20px;
          background: #333;
          color: #FF0000;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-weight: bold;
        `;

        const unattemptedTab = document.createElement('button');
        unattemptedTab.textContent = 'Unattempted Questions';
        unattemptedTab.style.cssText = `
          padding: 10px 20px;
          background: #333;
          color: #FFA500;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-weight: bold;
        `;

        tabsDiv.appendChild(correctTab);
        tabsDiv.appendChild(wrongTab);
        tabsDiv.appendChild(unattemptedTab);
        answersReviewDiv.appendChild(tabsDiv);

        // Create content containers
        const correctContent = document.createElement('div');
        correctContent.className = 'tab-content';
        correctContent.style.cssText = `
          display: none;
          padding: 20px;
          border-radius: 8px;
        `;

        const wrongContent = document.createElement('div');
        wrongContent.className = 'tab-content';
        wrongContent.style.cssText = `
          display: none;
          padding: 20px;
          border-radius: 8px;
        `;

        const unattemptedContent = document.createElement('div');
        unattemptedContent.className = 'tab-content';
        unattemptedContent.style.cssText = `
          display: none;
          padding: 20px;
          border-radius: 8px;
        `;

        answersReviewDiv.appendChild(correctContent);
        answersReviewDiv.appendChild(wrongContent);
        answersReviewDiv.appendChild(unattemptedContent);
        resultsContent.appendChild(answersReviewDiv);

        // Process answers for all tabs
        let correctAnswers = [];
        let wrongAnswers = [];
        let unattemptedAnswers = [];

        for (const [sectionKey, sectionData] of Object.entries(responseData.sections)) {
          const [subject, section] = sectionKey.split('-');
          const firstQuestionId = sectionData.questions[0]?.questionId;
          const isNumerical = firstQuestionId && parseInt(firstQuestionId.substring(1)) > 20;
          const sectionNumber = isNumerical ? '2' : '1';
          const sectionType = isNumerical ? 'num' : 'mcq';
          const fullSection = `sec-${sectionNumber}-${sectionType}`;

          try {
            const path = `years/${responseData.testInfo.year}/${responseData.testInfo.month}/${responseData.testInfo.shift}/subjects/${subject}/sections/${fullSection}/questions`;
            const questionsSnapshot = await db.collection(path).get();
            
            if (questionsSnapshot.empty) continue;
            
            const correctAnswersMap = {};
            questionsSnapshot.forEach(doc => {
              correctAnswersMap[doc.id] = doc.data();
            });

            sectionData.questions.forEach(question => {
              const userResponse = question.response;
              const correctAnswer = correctAnswersMap[question.questionId]?.correct;
              const questionText = correctAnswersMap[question.questionId]?.question;
              
              if (!userResponse) {
                unattemptedAnswers.push({
                  subject: subject.charAt(0).toUpperCase() + subject.slice(1),
                  section: `Section ${sectionNumber} (${sectionType.toUpperCase()})`,
                  questionNumber: question.questionId,
                  questionText,
                  userAnswer: userResponse,
                  correctAnswer: isNumerical ? correctAnswer : String.fromCharCode(64 + parseInt(correctAnswer))
                });
              } else {
                const isCorrect = isNumerical 
                  ? Math.abs(parseFloat(userResponse) - parseFloat(correctAnswer)) < 0.0001
                  : (userResponse.charCodeAt(0) - 64) === parseInt(correctAnswer);

                const answerInfo = {
                  subject: subject.charAt(0).toUpperCase() + subject.slice(1),
                  section: `Section ${sectionNumber} (${sectionType.toUpperCase()})`,
                  questionNumber: question.questionId,
                  questionText,
                  userAnswer: userResponse,
                  correctAnswer: isNumerical ? correctAnswer : String.fromCharCode(64 + parseInt(correctAnswer))
                };

                if (isCorrect) {
                  correctAnswers.push(answerInfo);
                } else {
                  wrongAnswers.push(answerInfo);
                }
              }
            });
          } catch (error) {
            console.error('Error processing answers:', error);
          }
        }

        // Populate correct answers tab
        if (correctAnswers.length > 0) {
          correctAnswers.forEach(answer => {
            const answerDiv = document.createElement('div');
            answerDiv.style.cssText = `
              background: #fff;
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 15px;
              border-left: 4px solid #00ff00;
            `;

            // Check if question text is an image URL
            const isQuestionImage = /^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(answer.questionText?.trim());
            const questionContent = isQuestionImage 
              ? `<img src="${answer.questionText}" style="max-width: 100%; height: auto; margin: 10px 0;" alt="Question Image">`
              : `<p style="margin: 0 0 10px 0; color: #333;">${answer.questionText}</p>`;

            answerDiv.innerHTML = `
              <h3 style="margin: 0 0 10px 0; color: #333;">${answer.subject} - ${answer.section}</h3>
              <p style="margin: 0 0 10px 0; color: #666;">Question ${answer.questionNumber}</p>
              ${questionContent}
              <p style="margin: 0; color: #00ff00; font-weight: bold;">Your Answer: ${answer.userAnswer}</p>
            `;
            correctContent.appendChild(answerDiv);
          });
        } else {
          correctContent.innerHTML = '<p style="text-align: center; color: #666;">No correct answers to display</p>';
        }

        // Populate wrong answers tab
        if (wrongAnswers.length > 0) {
          wrongAnswers.forEach(answer => {
            const answerDiv = document.createElement('div');
            answerDiv.style.cssText = `
              background: #fff;
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 15px;
              border-left: 4px solid #ff4444;
            `;

            // Check if question text is an image URL
            const isQuestionImage = /^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(answer.questionText?.trim());
            const questionContent = isQuestionImage 
              ? `<img src="${answer.questionText}" style="max-width: 100%; height: auto; margin: 10px 0;" alt="Question Image">`
              : `<p style="margin: 0 0 10px 0; color: #333;">${answer.questionText}</p>`;

            answerDiv.innerHTML = `
              <h3 style="margin: 0 0 10px 0; color: #333;">${answer.subject} - ${answer.section}</h3>
              <p style="margin: 0 0 10px 0; color: #666;">Question ${answer.questionNumber}</p>
              ${questionContent}
              <p style="margin: 0 0 5px 0; color: #ff4444; font-weight: bold;">Your Answer: ${answer.userAnswer}</p>
              <p style="margin: 0; color: #00ff00; font-weight: bold;">Correct Answer: ${answer.correctAnswer}</p>
            `;
            wrongContent.appendChild(answerDiv);
          });
        } else {
          wrongContent.innerHTML = '<p style="text-align: center; color: #666;">No wrong answers to display</p>';
        }

        // Populate unattempted answers tab
        if (unattemptedAnswers.length > 0) {
          unattemptedAnswers.forEach(answer => {
            const answerDiv = document.createElement('div');
            answerDiv.style.cssText = `
              background: #fff;
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 15px;
              border-left: 4px solid #FFA500;
            `;

            // Check if question text is an image URL
            const isQuestionImage = /^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(answer.questionText?.trim());
            const questionContent = isQuestionImage 
              ? `<img src="${answer.questionText}" style="max-width: 100%; height: auto; margin: 10px 0;" alt="Question Image">`
              : `<p style="margin: 0 0 10px 0; color: #333;">${answer.questionText}</p>`;

            answerDiv.innerHTML = `
              <h3 style="margin: 0 0 10px 0; color: #333;">${answer.subject} - ${answer.section}</h3>
              <p style="margin: 0 0 10px 0; color: #666;">Question ${answer.questionNumber}</p>
              ${questionContent}
              <p style="margin: 0 0 5px 0; color: #FFFFFF; font-weight: bold;">Status: Unattempted</p>
              <p style="margin: 0; color: #00ff00; font-weight: bold;">Correct Answer: ${answer.correctAnswer}</p>
            `;
            unattemptedContent.appendChild(answerDiv);
          });
        } else {
          unattemptedContent.innerHTML = '<p style="text-align: center; color: #666;">No unattempted questions to display</p>';
        }

        // Add tab switching functionality
        correctTab.onclick = () => {
          correctTab.style.background = '#00ff00';
          correctTab.style.color = '#000';
          wrongTab.style.background = '#333';
          wrongTab.style.color = '#fff';
          unattemptedTab.style.background = '#333';
          unattemptedTab.style.color = '#FFFFFF';
          correctContent.style.display = 'block';
          wrongContent.style.display = 'none';
          unattemptedContent.style.display = 'none';
        };

        wrongTab.onclick = () => {
          wrongTab.style.background = '#FF0000';
          wrongTab.style.color = '#000';
          correctTab.style.background = '#333';
          correctTab.style.color = '#fff';
          unattemptedTab.style.background = '#333';
          unattemptedTab.style.color = '#FFFFFF';
          wrongContent.style.display = 'block';
          correctContent.style.display = 'none';
          unattemptedContent.style.display = 'none';
        };

        unattemptedTab.onclick = () => {
          unattemptedTab.style.background = '#FFA500';
          unattemptedTab.style.color = '#000';
          correctTab.style.background = '#333';
          correctTab.style.color = '#fff';
          wrongTab.style.background = '#333';
          wrongTab.style.color = '#fff';
          unattemptedContent.style.display = 'block';
          correctContent.style.display = 'none';
          wrongContent.style.display = 'none';
        };

        // Show correct answers tab by default
        correctTab.click();

        // Add back button
        const backButton = document.createElement('button');
        backButton.textContent = 'Back to Dashboard';
        backButton.style.cssText = `
          display: block;
          margin: 20px auto;
          padding: 10px 20px;
          background: #ff69b4;
          color: #fff;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-weight: bold;
        `;
        backButton.onclick = () => window.location.href = 'dashboard.html';
        resultsContent.appendChild(backButton);

        // Calculate overall and subjectwise accuracy
        totalCorrect = Object.values(subjectwiseStats).reduce((a, s) => a + s.correct, 0);
        totalAttempted = Object.values(subjectwiseStats).reduce((a, s) => a + s.attempted, 0);
        const overallAccuracy = totalAttempted > 0 ? (totalCorrect / totalAttempted) * 100 : 0;
        // Render accuracy section
        const accuracyList = document.getElementById('accuracy-list');
        accuracyList.innerHTML = '';
        const overallLi = document.createElement('li');
        overallLi.innerHTML = `<span class="accuracy-label">Overall Accuracy:</span> <span class="accuracy-value">${overallAccuracy.toFixed(1)}%</span>`;
        accuracyList.appendChild(overallLi);
        for (const [subject, stats] of Object.entries(subjectwiseStats)) {
          const subjectAcc = stats.attempted > 0 ? (stats.correct / stats.attempted) * 100 : 0;
          const li = document.createElement('li');
          li.innerHTML = `<span class="accuracy-label">${subject.charAt(0).toUpperCase() + subject.slice(1)}:</span> <span class="accuracy-value">${subjectAcc.toFixed(1)}%</span>`;
          accuracyList.appendChild(li);
        }

        // Log actual section keys for debugging
        console.log('Actual section keys:', Object.keys(responseData.sections));

        // Always show 6 fixed rows for each subject-section
        const sectionKeys = [
          { key: 'physics-sec-1-mcq', label: 'Physics – Single Option', subjects: ['physics'], section: 'sec-1', type: 'mcq' },
          { key: 'physics-sec-2-num', label: 'Physics – Integer type', subjects: ['physics'], section: 'sec-2', type: 'num' },
          { key: 'chemistry-sec-1-mcq', label: 'Chemistry – Single Option', subjects: ['chemistry'], section: 'sec-1', type: 'mcq' },
          { key: 'chemistry-sec-2-num', label: 'Chemistry – Integer type', subjects: ['chemistry'], section: 'sec-2', type: 'num' },
          { key: 'math-sec-1-mcq', label: 'Math – Single Option', subjects: ['math', 'maths'], section: 'sec-1', type: 'mcq' },
          { key: 'math-sec-2-num', label: 'Math – Integer type', subjects: ['math', 'maths'], section: 'sec-2', type: 'num' },
        ];
        const sectionStats = {};
        for (const { key } of sectionKeys) {
          sectionStats[key] = { score: 0, attempted: 0, correct: 0, incorrect: 0, unattempted: 0 };
        }

        // Async: fetch correct answers for each section and compute stats
        let totalScoreAsync = 0;
        let totalCorrectAsync = 0;
        let totalAttemptedAsync = 0;
        let subjectwiseStatsAsync = { physics: {correct:0, attempted:0}, chemistry: {correct:0, attempted:0}, math: {correct:0, attempted:0}, maths: {correct:0, attempted:0} };
        await Promise.all(sectionKeys.map(async ({ key, subjects, section, type }) => {
          // Try both 'math' and 'maths' as subject keys if needed
          let found = false;
          let usedSubject = null;
          let dataKey = null;
          let sectionData = null;
          for (const subject of subjects) {
            const matchingKeys = Object.keys(responseData.sections).filter(k => k.startsWith(`${subject}-${section}`));
            if (matchingKeys.length > 0) {
              dataKey = matchingKeys[0];
              sectionData = responseData.sections[dataKey];
              usedSubject = subject;
              found = true;
              break;
            }
          }
          if (!found) return;
          // Try both possible Firestore paths for correct answers
          let fullSection = `${section}-${type}`;
          let path = `years/${responseData.testInfo.year}/${responseData.testInfo.month}/${responseData.testInfo.shift}/subjects/${usedSubject}/sections/${fullSection}/questions`;
          let correctAnswersMap = {};
          let questionsSnapshot = null;
          try {
            questionsSnapshot = await db.collection(path).get();
          } catch (e) { /* ignore */ }
          if (!questionsSnapshot || questionsSnapshot.empty) {
            // Try alternate path (e.g., sec-1 if sec-1-mcq fails)
            fullSection = section;
            path = `years/${responseData.testInfo.year}/${responseData.testInfo.month}/${responseData.testInfo.shift}/subjects/${usedSubject}/sections/${fullSection}/questions`;
            try {
              questionsSnapshot = await db.collection(path).get();
            } catch (e) { /* ignore */ }
          }
          if (questionsSnapshot && !questionsSnapshot.empty) {
            questionsSnapshot.forEach(doc => {
              correctAnswersMap[doc.id] = doc.data().correct;
            });
          }
          // Compute stats
          sectionData.questions.forEach(q => {
            if (!q.response) {
              sectionStats[key].unattempted++;
            } else {
              sectionStats[key].attempted++;
              totalAttemptedAsync++;
              subjectwiseStatsAsync[usedSubject].attempted++;
              const correctAnswer = correctAnswersMap[q.questionId];
              const isNumerical = q.questionId && parseInt(q.questionId.substring(1)) > 20;
              if (isNumerical) {
                const userNum = parseFloat(q.response);
                const correctNum = parseFloat(correctAnswer);
                if (!isNaN(userNum) && !isNaN(correctNum) && Math.abs(userNum - correctNum) < 0.0001) {
                  sectionStats[key].correct++;
                  sectionStats[key].score += 4;
                  totalScoreAsync += 4;
                  totalCorrectAsync++;
                  subjectwiseStatsAsync[usedSubject].correct++;
                } else {
                  sectionStats[key].incorrect++;
                  sectionStats[key].score -= 1;
                  totalScoreAsync -= 1;
                }
              } else {
                const userResponseNum = q.response.charCodeAt(0) - 64;
                const correctAnswerNum = parseInt(correctAnswer);
                if (userResponseNum === correctAnswerNum) {
                  sectionStats[key].correct++;
                  sectionStats[key].score += 4;
                  totalScoreAsync += 4;
                  totalCorrectAsync++;
                  subjectwiseStatsAsync[usedSubject].correct++;
                } else {
                  sectionStats[key].incorrect++;
                  sectionStats[key].score -= 1;
                  totalScoreAsync -= 1;
                }
              }
            }
          });
        }));

        const subjectSummaryBody = subjectSummaryTable.querySelector('#subject-summary-body');
        for (const { key, label } of sectionKeys) {
          const stats = sectionStats[key];
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:8px; border:1px solid #444;">${label}</td>
            <td style="padding:8px; border:1px solid #444;">${stats.score.toFixed(2)}</td>
            <td style="padding:8px; border:1px solid #444;">${stats.attempted}</td>
            <td style="padding:8px; border:1px solid #444;">${stats.correct}</td>
            <td style="padding:8px; border:1px solid #444;">${stats.incorrect}</td>
            <td style="padding:8px; border:1px solid #444;">${stats.unattempted}</td>
          `;
          subjectSummaryBody.appendChild(tr);
        }

        // Update total score and accuracy using async-calculated values
        document.querySelector('.total-score').textContent = `Total Score: ${totalScoreAsync}`;
        const accuracyListFinal = document.getElementById('accuracy-list');
        accuracyListFinal.innerHTML = '';
        const overallAccuracyFinal = totalAttemptedAsync > 0 ? (totalCorrectAsync / totalAttemptedAsync) * 100 : 0;
        const overallLiFinal = document.createElement('li');
        overallLiFinal.innerHTML = `<span class="accuracy-label">Overall Accuracy:</span> <span class="accuracy-value">${overallAccuracyFinal.toFixed(1)}%</span>`;
        accuracyListFinal.appendChild(overallLiFinal);
        for (const subject of ['physics','chemistry','math']) {
          const stats = subjectwiseStatsAsync[subject];
          const subjectAcc = stats.attempted > 0 ? (stats.correct / stats.attempted) * 100 : 0;
          const li = document.createElement('li');
          li.innerHTML = `<span class="accuracy-label">${subject.charAt(0).toUpperCase() + subject.slice(1)}:</span> <span class="accuracy-value">${subjectAcc.toFixed(1)}%</span>`;
          accuracyListFinal.appendChild(li);
        }

      } catch (error) {
        console.error('Error loading results:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          code: error.code
        });
        showError('Error loading results. Please try again later.');
      }
    }

    async function calculateSectionScore(subject, section, questions, testInfo, uiSectionKey, subjectwiseStats) {
      try {
        console.log('Calculating score for:', { subject, section, questions, testInfo, uiSectionKey });
        const { year, month, shift } = testInfo;
        
        // Determine if this is a numerical section
        const isNumerical = section.includes('sec-2') || section.includes('num');
        const sectionType = isNumerical ? 'num' : 'mcq';
        const sectionNumber = isNumerical ? '2' : '1';
        const fullSection = `sec-${sectionNumber}-${sectionType}`;
        
        console.log('Section type detection:', {
          section,
          isNumerical,
          sectionType,
          sectionNumber,
          fullSection
        });
        
        // Construct the path to correct answers
        const path = `years/${year}/${month}/${shift}/subjects/${subject}/sections/${fullSection}/questions`;
        console.log('Fetching correct answers from path:', path);
        
        const questionsSnapshot = await db.collection(path).get();
        console.log('Questions snapshot:', questionsSnapshot);
        
        if (questionsSnapshot.empty) {
          console.error('No questions found at path:', path);
          throw new Error(`No questions found for ${subject} ${fullSection}`);
        }
        
        // Create a map of correct answers
        const correctAnswers = {};
        questionsSnapshot.forEach(doc => {
          const data = doc.data();
          console.log('Question data:', { id: doc.id, data });
          // Store the correct answer
          correctAnswers[doc.id] = data.correct;
        });
        console.log('Correct answers map:', correctAnswers);

        let correct = 0;
        let incorrect = 0;
        let unattempted = 0;
        let score = 0;

        // Process each question
        questions.forEach(question => {
          const userResponse = question.response;
          const correctAnswer = correctAnswers[question.questionId];
          
          console.log('Processing question:', {
            questionId: question.questionId,
            userResponse,
            correctAnswer,
            question,
            isNumerical
          });

          if (!subjectwiseStats[subject]) subjectwiseStats[subject] = {correct: 0, attempted: 0};

          if (!userResponse) {
            // Question was not attempted
            unattempted++;
            console.log('Question unattempted');
          } else {
            subjectwiseStats[subject].attempted++;
            // For numerical questions (Section 2)
            if (isNumerical) {
              // Convert both to numbers and compare
              const userNum = parseFloat(userResponse);
              const correctNum = parseFloat(correctAnswer);
              
              console.log('Numerical comparison:', {
                userResponse,
                userNum,
                correctAnswer,
                correctNum,
                isEqual: userNum === correctNum,
                userResponseType: typeof userResponse,
                correctAnswerType: typeof correctAnswer,
                userNumType: typeof userNum,
                correctNumType: typeof correctNum
              });
              
              // Check if both numbers are valid
              if (!isNaN(userNum) && !isNaN(correctNum)) {
                // Compare with a small tolerance for floating point numbers
                const isEqual = Math.abs(userNum - correctNum) < 0.0001;
                
                if (isEqual) {
                  correct++;
                  subjectwiseStats[subject].correct++;
                  score += 4;
                  console.log('Correct numerical answer: +4');
                } else {
                  incorrect++;
                  score -= 1;
                  console.log('Incorrect numerical answer: -1');
                }
              } else {
                incorrect++;
                score -= 1;
                console.log('Invalid numerical answer: -1');
              }
            } else {
              // For MCQ questions (Section 1)
              // Convert user's letter response (A,B,C,D) to number (1,2,3,4)
              const userResponseNum = userResponse.charCodeAt(0) - 64; // A->1, B->2, C->3, D->4
              const correctAnswerNum = parseInt(correctAnswer);
              
              console.log('MCQ comparison:', {
                userResponse,
                userResponseNum,
                correctAnswer,
                correctAnswerNum,
                isEqual: userResponseNum === correctAnswerNum
              });
              
              if (userResponseNum === correctAnswerNum) {
                correct++;
                subjectwiseStats[subject].correct++;
                score += 4;
                console.log('Correct MCQ answer: +4');
              } else {
                incorrect++;
                score -= 1;
                console.log('Incorrect MCQ answer: -1');
              }
            }
          }
        });

        console.log('Section results:', {
          subject,
          section: fullSection,
          correct,
          incorrect,
          unattempted,
          score,
          correctAnswers,
          questions
        });

        // Update UI using the provided uiSectionKey
        document.getElementById(`${uiSectionKey}-correct`).textContent = correct;
        document.getElementById(`${uiSectionKey}-incorrect`).textContent = incorrect;
        document.getElementById(`${uiSectionKey}-unattempted`).textContent = unattempted;
        document.getElementById(`${uiSectionKey}-score`).textContent = score;

        return score;
      } catch (error) {
        console.error('Error calculating section score:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          code: error.code
        });
        throw error;
      }
    }

    function showError(message) {
      const resultsContent = document.getElementById('results-content');
      resultsContent.innerHTML = '';
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      resultsContent.appendChild(errorDiv);
    }
  </script>
</body>
</html>

